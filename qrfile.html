<!DOCTYPE html>
<html>
  <head>
    <title>QR Code Generator</title>
    <style>
      .qr-element {
        padding: 20px;
        margin-bottom: 20px;
        display: block;
      }
      .file-list-item {
        margin-bottom: 5px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
  </head>
  <body>
    <input type="file" id="file-input" onchange="handleFiles(this.files)" />
    <div id="file-list"></div>

    <div id="qrcode-area"></div>

    <script>
      const fileList = [];

      function handleFiles(selectedFiles) {
        Array.from(selectedFiles).forEach((file) => {
          if (
            fileList.length < 5 &&
            !fileList.map((f) => f.name).includes(file.name)
          ) {
            fileList.push(file);
            updateFileList();
          }
        });
      }

      function updateFileList() {
        const fileListContainer = document.getElementById("file-list");
        fileListContainer.innerHTML = ""; // Clear the list

        fileList.forEach((file, index) => {
          const fileListItem = document.createElement("div");
          fileListItem.className = "file-list-item";
          fileListItem.textContent = file.name;

          const generateButton = document.createElement("button");
          generateButton.textContent = "Generate QR Code";
          generateButton.onclick = function () {
            generateQRCode(file, index);
          };

          const resetButton = document.createElement("button");
          resetButton.textContent = "Reset";
          resetButton.onclick = function () {
            resetFile(index);
          };

          fileListItem.appendChild(generateButton);
          fileListItem.appendChild(resetButton);

          fileListContainer.appendChild(fileListItem);
        });
      }

      function resetFile(index) {
        fileList.splice(index, 1); // Remove the file from the list
        updateFileList(); // Update the file list display
        resetQRCode(); // Clear the QR code display area
      }

      function resetQRCode() {
        const qrcodeArea = document.getElementById("qrcode-area");
        qrcodeArea.innerHTML = "";
      }

      function generateQRCode(file, index) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const text = e.target.result;
          const chunkSize = 1200; // QRコードにエンコードするデータの最大サイズを設定
          const numChunks = Math.ceil(text.length / chunkSize);
          const qrcodeArea = document.getElementById("qrcode-area");
          qrcodeArea.innerHTML = `<div>Generating QR codes for "${file.name}", divided into ${numChunks} parts...</div>`;

          for (let i = 0; i < numChunks; i++) {
            const header = `${file.name} ${i + 1}/${numChunks}\n`;
            const chunk = text.slice(i * chunkSize, (i + 1) * chunkSize);
            const qrText = header + chunk;
            const str_sjis = Encoding.convert(qrText, "SJIS"); // Shift-JISにエンコード

            const qrDiv = document.createElement("div");
            qrDiv.className = "qr-element";

            try {
              $(qrDiv).qrcode({
                width: 450,
                height: 450,
                text: str_sjis,
              });
            } catch (e) {
              alert("Illegal data set: " + e.toString());
            }

            qrcodeArea.appendChild(qrDiv);
          }
        };
        reader.readAsText(file);
      }
    </script>
  </body>
</html>
